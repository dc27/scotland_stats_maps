---
title: "Data Extractaction and Exploration"
output: html_notebook
---

```{r}
library(opendatascot)
library(tidyverse)
```

```{r}
ods_all_datasets() %>% 
  janitor::clean_names() %>% 
  filter(name == "Life Expectancy") %>% 
  select(uri)
```


```{r}
library(rgdal)
```

```{r}
hb_shapes <- readOGR(
  dsn ="data/simplified_shapefiles/health_boards/NHS_HealthBoards_2019/",
  layer = "NHS_HealthBoards_2019",
  GDAL1_integer64_policy = TRUE)
```


```{r}
library(rgeos)
```

```{r}
hb_simple <- gSimplify(hb_shapes, tol = 0.005, topologyPreserve = TRUE)
```


```{r}
hb_lookup <- hb_shapes@data %>% 
  select(1,2) %>% 
  rowid_to_column("id") %>%
  mutate(id = as.character(id-1)) %>% 
  janitor::clean_names()
```

56.3950° N, 3.4308° W

```{r}
plot(hb_simple, xlim = c(-3.66, -3.50), ylim = c(55,61))
```

```{r}
uk_shape <- readOGR(
   dsn ="../Downloads/scot_stats_dashboard/bdline_essh_gb/Data/GB/",
   layer = "county_elect",
   GDAL1_integer64_policy = TRUE)
 
 uk_simple <- gSimplify(uk_shape, tol = 0.1, topologyPreserve = TRUE)
```

```{r}
plot(uk_simple)
```





```{r}
library(maps)
```


```{r}
UK <- map_data("world") %>% filter(region == "UK")
```


```{r}
UK
```



```{r}
library(broom)
```


```{r}
spdf_fortified <- tidy(hb_simple, region = "code")
```



```{r}
spdf_fortified
```

```{r}
hle_map_data <- spdf_fortified %>% 
  left_join(hb_lookup, by = c("id" = "id")) %>% 
  left_join(hle_data, by = c("hb_name" = "reference_area"))
```

```{r}
library(plotly)
```


```{r}
hle_data <- read_csv("data/clean_data/healthy_life_expectancy.csv")
```

```{r}
ref_period_var <- "2015-2017"
sex_var <- "male"


user_selections <- list(
  reference_period = "2015-2017",
  sex = "male"
)
```

```{r}
user_selections
```

```{r}


```


```{r} 
filtered_hle_data <- filter_df(hle_data, user_selections)
```


```{r}
filtered_hle_data
```


```{r}
library(leaflet)
```

```{r}
my_map <- leaflet(options = leafletOptions(minZoom = 6)) %>%
    setView(lng = -5, lat = 57.35, zoom = 6) %>%
    # restrict view to around Scotland
    setMaxBounds(lng1 = -1,
                 lat1 = 50,
                 lng2 = -9,
                 lat2 = 64) %>% 
  addProviderTiles(providers$CartoDB.PositronNoLabels)
```


```{r}
my_map
```



```{r}
hle_2015_m <- hle_data %>% 
  filter(sex == "male") %>% 
  filter(ref_period == "2015-2017")
```




```{r}
hb_shapes@data <- hb_shapes@data %>% 
  janitor::clean_names() %>% 
  left_join(hle_2015_m, by = c("hb_name" = "reference_area"))
```

```{r}
labels <- sprintf("<strong>%s</strong><br/>%g years",
                  hb_shapes$hb_name, hb_shapes$healthy_life_expectancy) %>%
  lapply(htmltools::HTML)
```


```{r}
# add Health Board polygons, colour based on LE, highlight on hover

my_map %>% 
    addPolygons(data = hb_shapes, color = "white",
                fillColor = ~colorQuantile(
                  "YlOrRd", (-hb_shapes$healthy_life_expectancy))
                (-hb_shapes$healthy_life_expectancy),
                weight = 1, fillOpacity = 0.9, label = labels,
                highlightOptions = highlightOptions(
                  color = "black", weight = 2,
                  opacity = 0.9, bringToFront = TRUE))
```



```{r}
hb_shapes@data %>% 
  rename("bean" = HBName)
```



```{r}
my_string <- "harry potter"
```

```{r}
stringr::str_to_title(my_string)
```

```{r}
library(RColorBrewer)
par(mar=c(3,4,2,2))
display.brewer.all()
```

```{r}
brewer.pal.info %>% 

```


```{r}

```


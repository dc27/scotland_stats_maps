---
title: "Data Extractaction and Exploration"
output: html_notebook
---

```{r}
library(tidyverse)

library(rgdal)
library(rgeos)
```

```{r}
hb_shapes <- readOGR(
  dsn ="data/simplified_shapefiles/health_boards/NHS_HealthBoards_2019/",
  layer = "NHS_HealthBoards_2019",
  GDAL1_integer64_policy = TRUE)
```

```{r}

```

```{r}
crs <- CRS("+proj=longlat +datum=WGS84")

# transform shape data to plot on map
la_shapes_ll <- la_shapes %>% 
  rgeos::gSimplify(tol=25, topologyPreserve=TRUE) %>% 
  spTransform(crs)

la_shapes@polygons <- la_shapes_ll@polygons
```


```{r}
plot(la_shapes)
```

```{r}
la_shapes <- la_shapes[str_detect(la_shapes$CODE, "^S"),]
```



```{r}
la_shapes@data %>%
  janitor::clean_names() %>% 
  select(area_name = name, c(ends_with("id"), code))
```


```{r}
my_map %>% 
    addPolygons(data = la_shapes, color = "white",
                fillColor = "Blue",
                weight = 1, fillOpacity = 0.9)
```


```{r}
la_shapes@data
```



```{r}
library(rgeos)
```

```{r}
hb_simple <- gSimplify(hb_shapes, tol = 0.005, topologyPreserve = TRUE)
```


```{r}
hb_lookup <- hb_shapes@data %>% 
  select(1,2) %>% 
  rowid_to_column("id") %>%
  mutate(id = as.character(id-1)) %>% 
  janitor::clean_names()
```

56.3950° N, 3.4308° W

```{r}
plot(hb_simple, xlim = c(-3.66, -3.50), ylim = c(55,61))
```

```{r}
uk_shape <- readOGR(
   dsn ="../Downloads/scot_stats_dashboard/bdline_essh_gb/Data/GB/",
   layer = "county_elect",
   GDAL1_integer64_policy = TRUE)
 
 uk_simple <- gSimplify(uk_shape, tol = 0.1, topologyPreserve = TRUE)
```

```{r}
plot(uk_simple)
```





```{r}
library(maps)
```


```{r}
UK <- map_data("world") %>% filter(region == "UK")
```


```{r}
UK
```



```{r}
library(broom)
```


```{r}
spdf_fortified <- tidy(hb_simple, region = "code")
```



```{r}
spdf_fortified
```

```{r}
hle_map_data <- spdf_fortified %>% 
  left_join(hb_lookup, by = c("id" = "id")) %>% 
  left_join(hle_data, by = c("hb_name" = "reference_area"))
```

```{r}
library(plotly)
```


```{r}
hle_data <- read_csv("data/clean_data/healthy_life_expectancy.csv")
```

```{r}
ref_period_var <- "2015-2017"
sex_var <- "male"


user_selections <- list(
  reference_period = "2015-2017",
  sex = "male"
)
```

```{r}
user_selections
```

```{r}


```


```{r} 
filtered_hle_data <- filter_df(hle_data, user_selections)
```


```{r}
filtered_hle_data
```


```{r}
library(leaflet)
```

```{r}
my_map <- leaflet(options = leafletOptions(minZoom = 6)) %>%
    setView(lng = -5, lat = 57.35, zoom = 6) %>%
    # restrict view to around Scotland
    setMaxBounds(lng1 = -1,
                 lat1 = 50,
                 lng2 = -9,
                 lat2 = 64) %>% 
  addProviderTiles(providers$CartoDB.PositronNoLabels)
```


```{r}
my_map
```



```{r}
hle_2015_m <- hle_data %>% 
  filter(sex == "male") %>% 
  filter(ref_period == "2015-2017")
```




```{r}
hb_shapes@data <- hb_shapes@data %>% 
  janitor::clean_names() %>% 
  left_join(hle_2015_m, by = c("hb_name" = "reference_area"))
```

```{r}
labels <- sprintf("<strong>%s</strong><br/>%g years",
                  hb_shapes$hb_name, hb_shapes$healthy_life_expectancy) %>%
  lapply(htmltools::HTML)
```


```{r}
# add Health Board polygons, colour based on LE, highlight on hover

my_map %>% 
    addPolygons(data = hb_shapes, color = "white",
                fillColor = ~colorQuantile(
                  "YlOrRd", (-hb_shapes$healthy_life_expectancy))
                (-hb_shapes$healthy_life_expectancy),
                weight = 1, fillOpacity = 0.9, label = labels,
                highlightOptions = highlightOptions(
                  color = "black", weight = 2,
                  opacity = 0.9, bringToFront = TRUE))
```

```{r}
```


```{r}
hle_data <- list(
  data = read_csv("data/clean_data/healthy_life_expectancy.csv"),
  explorable_vars = c("reference_period", "sex"),
  explorable_areas = c("health board", "local authority")
)

council_house_data <- list(
  data = read_csv("data/clean_data/council_house_sales.csv"),
  explorable_vars = c("year", "dwelling_type"),
  explorable_areas = c("health board", "local authority")
)
```


```{r}
# selectable vars
get_choices <- function(data_list) {
  
  choices = list()
  for (var in data_list$explorable_vars) {
    varname = enquo(var)
    choices[[var]] = data_list$data %>% 
      select(!!varname) %>% 
      distinct() %>% 
      pull()
    sort(choices[[var]])
  }
  
  return(choices)
}



get_choices(hle_data)
```



